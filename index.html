<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>60-Day Habit Transformation ‚Äî Premium Edition</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg-dark: #0a0e1a;
      --bg-mid: #111827;
      --card-bg: rgba(17, 24, 39, 0.85);
      --border: rgba(255,255,255,0.08);
      --text-primary: #f9fafb;
      --text-muted: #9ca3af;
      --accent-gold: #f59e0b;
      --accent-gold-light: #fbbf24;
      --glass: rgba(255,255,255,0.05);
      --glass-border: rgba(255,255,255,0.12);
      --success: #10b981;
      --radius: 16px;
      --max-width: 1400px;
      --shadow-luxury: 0 20px 60px rgba(0,0,0,0.5), 0 0 1px rgba(255,255,255,0.1);
    }
    
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    
    html,body{
      height:100%;
      font-family:Inter,system-ui,-apple-system,sans-serif;
      color:var(--text-primary);
      background:var(--bg-dark);
    }
    
    body{
      background:radial-gradient(ellipse 120% 80% at 50% -20%, rgba(245,158,11,0.15), transparent 50%),
                  radial-gradient(ellipse 100% 60% at 80% 100%, rgba(59,130,246,0.08), transparent 50%),
                  linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-mid) 100%);
      padding:40px 24px;
      display:flex;
      justify-content:center;
      min-height:100vh;
    }
    
    .wrap{
      width:100%;
      max-width:var(--max-width);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:32px;
      margin-bottom:48px;
      flex-wrap:wrap;
    }
    
    .brand{
      display:flex;
      gap:20px;
      align-items:center;
    }
    
    .logo{
      width:64px;
      height:64px;
      border-radius:16px;
      background:linear-gradient(135deg,var(--accent-gold) 0%,var(--accent-gold-light) 100%);
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:28px;
      color:var(--bg-dark);
      box-shadow:0 10px 40px rgba(245,158,11,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    h1{
      font-size:32px;
      font-weight:800;
      letter-spacing:-0.02em;
      background:linear-gradient(135deg,var(--text-primary),var(--accent-gold-light));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .sub{
      color:var(--text-muted);
      font-size:15px;
      margin-top:6px;
      font-weight:500;
    }

    .top-stats{
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
    }
    
    .stat{
      background:var(--glass);
      backdrop-filter:blur(20px);
      padding:20px 28px;
      border-radius:14px;
      border:1px solid var(--glass-border);
      min-width:140px;
      text-align:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    
    .stat .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--text-muted);
      font-weight:600;
      margin-bottom:6px;
    }
    
    .stat strong{
      display:block;
      font-size:24px;
      font-weight:800;
      color:var(--accent-gold-light);
    }
    
    .card{
      background:var(--card-bg);
      backdrop-filter:blur(30px);
      padding:32px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow-luxury);
      margin-bottom:24px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 420px;
      gap:32px;
    }
    
    .small{
      font-size:13px;
      color:var(--text-muted);
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    
    .section-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:16px;
      color:var(--text-primary);
    }

    .habit-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
    }
    
    .habit{
      display:flex;
      align-items:center;
      gap:14px;
      padding:16px 20px;
      background:var(--glass);
      backdrop-filter:blur(10px);
      border-radius:12px;
      border:1px solid var(--glass-border);
      transition:all 0.2s ease;
    }
    
    .habit:hover{
      background:rgba(255,255,255,0.08);
      border-color:var(--accent-gold);
      transform:translateX(4px);
    }
    
    .habit input[type=text]{
      flex:1;
      background:transparent;
      border:0;
      color:var(--text-primary);
      outline:none;
      font-weight:600;
      font-size:15px;
    }
    
    .btn{
      background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-light));
      border:0;
      padding:12px 24px;
      color:var(--bg-dark);
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:all 0.2s ease;
      box-shadow:0 4px 16px rgba(245,158,11,0.3);
    }
    
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 24px rgba(245,158,11,0.5);
    }
    
    .btn.secondary{
      background:transparent;
      border:1px solid var(--glass-border);
      color:var(--text-muted);
      font-weight:600;
      box-shadow:none;
    }
    
    .btn.secondary:hover{
      border-color:var(--accent-gold);
      color:var(--accent-gold-light);
      background:rgba(245,158,11,0.05);
    }

    .day-grid{
      display:grid;
      grid-template-columns:repeat(10,1fr);
      gap:10px;
      margin-top:20px;
    }
    
    .day{
      background:var(--glass);
      backdrop-filter:blur(10px);
      padding:16px 12px;
      border-radius:12px;
      border:1px solid var(--glass-border);
      text-align:center;
      font-size:13px;
      cursor:pointer;
      transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .day:hover{
      transform:translateY(-8px);
      box-shadow:0 16px 40px rgba(0,0,0,0.4);
      border-color:var(--accent-gold);
      background:rgba(245,158,11,0.1);
    }
    
    .day .dnum{
      font-weight:800;
      font-size:16px;
      color:var(--text-primary);
    }
    
    .day .ddate{
      font-size:11px;
      color:var(--text-muted);
      margin-top:8px;
      font-weight:500;
    }
    
    .day.done{
      background:linear-gradient(135deg,var(--success),#059669);
      color:var(--bg-dark);
      border-color:var(--success);
      box-shadow:0 8px 24px rgba(16,185,129,0.4);
    }
    
    .day.done .dnum,.day.done .ddate{
      color:var(--bg-dark);
    }
    
    .day.today{
      outline:2px solid var(--accent-gold);
      outline-offset:2px;
      box-shadow:0 0 0 4px rgba(245,158,11,0.2);
    }

    #dayChecklistArea{
      margin-top:32px;
      padding-top:32px;
      border-top:1px solid var(--border);
    }
    
    .check-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      background:var(--glass);
      backdrop-filter:blur(10px);
      border-radius:10px;
      border:1px solid var(--glass-border);
      margin-bottom:12px;
      transition:all 0.2s ease;
    }
    
    .check-row:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(245,158,11,0.3);
    }
    
    .check-row input[type=checkbox]{
      width:24px;
      height:24px;
      cursor:pointer;
      accent-color:var(--accent-gold);
    }

    .progress{
      height:16px;
      background:rgba(0,0,0,0.3);
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--glass-border);
      box-shadow:inset 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .progress > i{
      display:block;
      height:100%;
      background:linear-gradient(90deg,var(--accent-gold),var(--accent-gold-light));
      width:0%;
      transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 0 20px rgba(245,158,11,0.6);
    }

    aside .card{
      position:sticky;
      top:40px;
    }

    footer{
      margin-top:48px;
      padding-top:32px;
      border-top:1px solid var(--border);
      color:var(--text-muted);
      font-size:13px;
      text-align:center;
    }

    @media(max-width:1200px){
      .grid{
        grid-template-columns:1fr 380px;
        gap:24px;
      }
    }
    
    @media(max-width:1000px){
      .grid{
        grid-template-columns:1fr;
      }
      .day-grid{
        grid-template-columns:repeat(8,1fr);
      }
    }
    
    @media(max-width:768px){
      .day-grid{
        grid-template-columns:repeat(5,1fr);
      }
      .top-stats{
        justify-content:center;
      }
      header{
        justify-content:center;
      }
    }
    
    @media(max-width:500px){
      .day-grid{
        grid-template-columns:repeat(3,1fr);
      }
      .brand{
        flex-direction:column;
        text-align:center;
      }
    }

    .muted{
      color:var(--text-muted);
    }
    
    .flex{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    input[type=date],input[type=text],textarea{
      background:var(--glass);
      backdrop-filter:blur(10px);
      border:1px solid var(--glass-border);
      color:var(--text-primary);
      padding:12px 16px;
      border-radius:10px;
      font-size:14px;
      transition:all 0.2s ease;
    }
    
    input[type=date]:focus,input[type=text]:focus,textarea:focus{
      outline:none;
      border-color:var(--accent-gold);
      background:rgba(245,158,11,0.05);
      box-shadow:0 0 0 3px rgba(245,158,11,0.1);
    }
    
    textarea{
      resize:vertical;
      font-family:inherit;
    }
    
    hr{
      border:0;
      border-top:1px solid var(--border);
      margin:24px 0;
    }
    
    code{
      background:rgba(0,0,0,0.4);
      padding:3px 8px;
      border-radius:6px;
      font-size:12px;
      color:var(--accent-gold-light);
      border:1px solid rgba(245,158,11,0.2);
    }
    
    ol,ul{
      line-height:1.8;
    }
    
    ol li,ul li{
      margin-bottom:8px;
    }
    
    strong{
      color:var(--text-primary);
      font-weight:700;
    }

    /* small utility */
    .muted-small { color:var(--text-muted); font-size:13px; }
    .danger { color:#fb7185; }
    .pill { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); border:1px solid var(--glass-border); font-weight:700; font-size:13px }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">60</div>
        <div>
          <h1>60-Day Habit Transformation</h1>
          <div class="sub">Elite system for building consistent sleep, nutrition & movement habits</div>
        </div>
      </div>

      <div class="top-stats">
        <div class="stat">
          <div class="label">Start Date</div>
          <strong id="startDate">(not set)</strong>
        </div>
        <div class="stat">
          <div class="label">Days Completed</div>
          <strong id="daysTracked">0</strong><span style="color:var(--text-muted);font-size:14px">/60</span>
        </div>
        <div class="stat">
          <div class="label">Overall Progress</div>
          <strong id="percent">0%</strong>
        </div>
      </div>
    </header>

    <div class="grid">
      <section>
        <div class="card">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;align-items:start">
            <div>
              <div class="small">Select your 60-day start date</div>
              <input type="date" id="start" style="width:100%;margin-top:12px" />
            </div>
            <div>
              <div class="small">Overall Progress</div>
              <div class="progress" style="margin-top:12px"><i id="progFill"></i></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:48px">
            <div>
              <h3 class="section-title">Daily Habits</h3>
              <div class="habit-list" id="habitList"></div>

              <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
                <input id="newHabit" type="text" placeholder="Add custom habit..." style="flex:1;min-width:200px" />
                <button class="btn" id="addHabit">Add Habit</button>
                <button class="btn secondary" id="resetHabits">Reset to Default</button>
              </div>
            </div>

            <div>
              <h3 class="section-title">60-Day Calendar</h3>
              <div class="small" style="margin-bottom:12px">Click any day to open its checklist</div>
              <div class="day-grid" id="dayGrid" aria-label="60 day calendar"></div>

              <div style="margin-top:20px;display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap">
                <div class="small">Selected: <strong id="selectedDayText" style="color:var(--text-primary)">None</strong></div>
                <div style="display:flex;gap:10px">
                  <button class="btn secondary" id="prevDay">‚Üê Prev</button>
                  <button class="btn secondary" id="nextDay">Next ‚Üí</button>
                </div>
              </div>
            </div>
          </div>

          <div id="dayChecklistArea" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap">
              <div>
                <div class="small">Checklist for</div>
                <h2 style="font-size:24px;font-weight:800;margin-top:8px" id="selectedDayHeader">Day 1</h2>
              </div>
              <div style="display:flex;gap:10px">
                <button class="btn secondary" id="clearDay">Clear Day</button>
                <button class="btn" id="markAll">Mark All Done</button>
              </div>
            </div>

            <div style="margin-top:24px" id="checklist"></div>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title">Your 60-Day Transformation Blueprint</h3>
          <p style="color:var(--text-muted);margin-bottom:20px;line-height:1.7">A carefully structured four-phase approach designed to build sustainable habits. Each phase lasts 15 days and builds upon the previous foundation.</p>

          <div style="display:grid;gap:20px">
            <div style="background:var(--glass);padding:20px;border-radius:12px;border:1px solid var(--glass-border)">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-light));display:grid;place-items:center;font-weight:900;color:var(--bg-dark)">1</div>
                <strong style="font-size:16px">Days 1‚Äì15: Sleep Foundation & Baseline</strong>
              </div>
              <p style="color:var(--text-muted);line-height:1.7;margin-left:52px">Move bedtime earlier by 15 minutes every 3 days until you achieve 7‚Äì8 hours. Eliminate screens 30 minutes before bed. Track sleep hours daily to establish your baseline.</p>
            </div>

            <div style="background:var(--glass);padding:20px;border-radius:12px;border:1px solid var(--glass-border)">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-light));display:grid;place-items:center;font-weight:900;color:var(--bg-dark)">2</div>
                <strong style="font-size:16px">Days 16‚Äì30: Stabilize Blood Sugar</strong>
              </div>
              <p style="color:var(--text-muted);line-height:1.7;margin-left:52px">Reduce refined carbohydrates, prioritize protein at breakfast, take 10‚Äì15 minute walks after meals, hydrate with water first thing each morning and between meals.</p>
            </div>

            <div style="background:var(--glass);padding:20px;border-radius:12px;border:1px solid var(--glass-border)">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-light));display:grid;place-items:center;font-weight:900;color:var(--bg-dark)">3</div>
                <strong style="font-size:16px">Days 31‚Äì45: Build Movement Capacity</strong>
              </div>
              <p style="color:var(--text-muted);line-height:1.7;margin-left:52px">Implement strength training twice weekly, brisk walks four times per week, short post-meal walks daily. Increase NEAT (non-exercise activity) through standing and stairs.</p>
            </div>

            <div style="background:var(--glass);padding:20px;border-radius:12px;border:1px solid var(--glass-border)">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-light));display:grid;place-items:center;font-weight:900;color:var(--bg-dark)">4</div>
                <strong style="font-size:16px">Days 46‚Äì60: Refine & Solidify</strong>
              </div>
              <p style="color:var(--text-muted);line-height:1.7;margin-left:52px">Optimize fasting windows, eliminate hidden calories, maintain consistent 7‚Äì8 hour sleep schedule. Consider lab work if improvements plateau.</p>
            </div>
          </div>

          <div style="margin-top:24px;padding:20px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px">
            <strong style="color:var(--accent-gold-light);display:block;margin-bottom:8px">üí° Pro Tip</strong>
            <p style="color:var(--text-muted);line-height:1.7">Begin with 3‚Äì4 core daily habits (sleep target, eliminate sugar after 8pm, 10-minute post-meal walk, 20‚Äì30 minute strength/cardio session). Only add new habits after maintaining consistency for one full week.</p>
          </div>
        </div>

      </section>

      <aside>
        <div class="card">
          <h3 class="section-title">Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:12px">
            <button class="btn" id="markToday" style="width:100%">üìÖ Open Today's Checklist</button>
            <button class="btn secondary" id="export" style="width:100%">üíæ Export Data (JSON)</button>
            <button class="btn secondary" id="importBtn" style="width:100%">üì• Import Data (JSON)</button>
            <input type="file" id="importFile" style="display:none" accept="application/json" />
            <button class="btn secondary" id="clearAll" style="width:100%;color:#fb7185;border-color:rgba(251,113,133,0.3)">üóëÔ∏è Clear All Data</button>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title">Default Habits</h3>
          <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">These habits load by default. Customize them to match your goals.</p>
          <ul style="list-style:none;padding:0">
            <li style="padding:12px;background:var(--glass);border-radius:8px;margin-bottom:8px;border:1px solid var(--glass-border)">‚úÖ Sleep ‚â• 7 hours</li>
            <li style="padding:12px;background:var(--glass);border-radius:8px;margin-bottom:8px;border:1px solid var(--glass-border)">üö´ No sugary drinks</li>
            <li style="padding:12px;background:var(--glass);border-radius:8px;margin-bottom:8px;border:1px solid var(--glass-border)">üç≥ Protein-rich breakfast</li>
            <li style="padding:12px;background:var(--glass);border-radius:8px;margin-bottom:8px;border:1px solid var(--glass-border)">üö∂ 10‚Äì15 min post-meal walk</li>
            <li style="padding:12px;background:var(--glass);border-radius:8px;margin-bottom:8px;border:1px solid var(--glass-border)">üí™ Strength training session</li>
          </ul>
        </div>

        <div class="card">
          <h3 class="section-title">How to Use</h3>
          <div style="display:flex;flex-direction:column;gap:16px">
            <div style="display:flex;gap:12px;align-items:start">
              <div style="min-width:32px;height:32px;border-radius:8px;background:var(--glass);display:grid;place-items:center;font-weight:700;color:var(--accent-gold)">1</div>
              <div style="flex:1">
                <strong style="display:block;margin-bottom:4px">Choose Start Date</strong>
                <p style="color:var(--text-muted);font-size:13px;line-height:1.6">Select day 1 to generate your 60-day calendar</p>
              </div>
            </div>
            <div style="display:flex;gap:12px;align-items:start">
              <div style="min-width:32px;height:32px;border-radius:8px;background:var(--glass);display:grid;place-items:center;font-weight:700;color:var(--accent-gold)">2</div>
              <div style="flex:1">
                <strong style="display:block;margin-bottom:4px">Customize Habits</strong>
                <p style="color:var(--text-muted);font-size:13px;line-height:1.6">Edit habits to align with your personal goals</p>
              </div>
            </div>
            <div style="display:flex;gap:12px;align-items:start">
              <div style="min-width:32px;height:32px;border-radius:8px;background:var(--glass);display:grid;place-items:center;font-weight:700;color:var(--accent-gold)">3</div>
              <div style="flex:1">
                <strong style="display:block;margin-bottom:4px">Track Progress</strong>
                <p style="color:var(--text-muted);font-size:13px;line-height:1.6">Click any day and check off completed habits</p>
              </div>
            </div>
            <div style="display:flex;gap:12px;align-items:start">
              <div style="min-width:32px;height:32px;border-radius:8px;background:var(--glass);display:grid;place-items:center;font-weight:700;color:var(--accent-gold)">4</div>
              <div style="flex:1">
                <strong style="display:block;margin-bottom:4px">Backup Data</strong>
                <p style="color:var(--text-muted);font-size:13px;line-height:1.6">Export/import to sync across devices</p>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <p style="line-height:1.8">Built for personal habit transformation. All data stored locally in your browser (localStorage). Deploy to GitHub: create a repository, upload this file as <code>index.html</code>, and enable GitHub Pages in repository settings.</p>
      <p style="margin-top:12px;color:rgba(156,163,175,0.6)">¬© 2025 60-Day Habit Transformation System</p>
    </footer>
  </div>

  <script>
    // Premium 60-day habit tracker with full functionality
    const STORAGE_KEY = 'habit60_premium_v1';
    const defaultHabits = [
      'Sleep ‚â• 7 hrs',
      'No sugary drinks',
      'Protein breakfast',
      '10‚Äì15 min post-meal walk',
      'Strength session (20‚Äì30 min)'
    ];

    // DOM elements
    const startInput = document.getElementById('start');
    const habitList = document.getElementById('habitList');
    const newHabit = document.getElementById('newHabit');
    const addHabit = document.getElementById('addHabit');
    const dayGrid = document.getElementById('dayGrid');
    const selectedDayText = document.getElementById('selectedDayText');
    const selectedDayHeader = document.getElementById('selectedDayHeader');
    const checklist = document.getElementById('checklist');
    const dayChecklistArea = document.getElementById('dayChecklistArea');
    const progFill = document.getElementById('progFill');
    const startDateLabel = document.getElementById('startDate');
    const daysTrackedLabel = document.getElementById('daysTracked');
    const percentLabel = document.getElementById('percent');
    const prevDayBtn = document.getElementById('prevDay');
    const nextDayBtn = document.getElementById('nextDay');
    const markAllBtn = document.getElementById('markAll');
    const clearDayBtn = document.getElementById('clearDay');
    const markTodayBtn = document.getElementById('markToday');
    const exportBtn = document.getElementById('export');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const clearAllBtn = document.getElementById('clearAll');
    const resetHabitsBtn = document.getElementById('resetHabits');

    // State
    let state = loadState();
    let selectedIndex = null; // 0-based index for days (0..59)

    // Helpers
    function formatDateYMD(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function todayAtMidnight() {
      const d = new Date();
      d.setHours(0,0,0,0);
      return d;
    }

    // Save & load
    function defaultState() {
      return {
        startDate: null, // 'YYYY-MM-DD'
        habits: [...defaultHabits],
        days: Array.from({length:60}, () => ({ checks: Array(defaultHabits.length).fill(false) }))
      };
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        // Basic migration/validation:
        if (!parsed.startDate) parsed.startDate = null;
        if (!Array.isArray(parsed.habits) || parsed.habits.length === 0) parsed.habits = [...defaultHabits];
        if (!Array.isArray(parsed.days) || parsed.days.length !== 60) {
          parsed.days = Array.from({length:60}, () => ({ checks: Array(parsed.habits.length).fill(false) }));
        } else {
          // Adapt day check arrays to current habit length
          parsed.days = parsed.days.map(d => {
            if (!Array.isArray(d.checks)) d.checks = Array(parsed.habits.length).fill(false);
            else if (d.checks.length < parsed.habits.length) {
              // extend
              return { checks: d.checks.concat(Array(parsed.habits.length - d.checks.length).fill(false)) };
            } else if (d.checks.length > parsed.habits.length) {
              // shrink (keep earliest)
              return { checks: d.checks.slice(0, parsed.habits.length) };
            }
            return { checks: d.checks };
          });
        }
        return parsed;
      } catch (e) {
        console.error('Failed reading state, resetting', e);
        return defaultState();
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // UI renderers
    function renderHabits() {
      habitList.innerHTML = '';
      state.habits.forEach((h, i) => {
        const row = document.createElement('div');
        row.className = 'habit';
        row.innerHTML = `
          <div class="pill">${i+1}</div>
          <input type="text" data-index="${i}" value="${escapeHtml(h)}" />
          <div style="display:flex;gap:8px">
            <button class="btn secondary" data-action="up" data-index="${i}" title="Move up">‚ñ≤</button>
            <button class="btn secondary" data-action="down" data-index="${i}" title="Move down">‚ñº</button>
            <button class="btn secondary" data-action="del" data-index="${i}" title="Delete">üóëÔ∏è</button>
          </div>
        `;
        habitList.appendChild(row);
      });

      // Attach listeners for habit input changes and buttons
      habitList.querySelectorAll('input[type=text]').forEach(inp => {
        inp.addEventListener('change', e => {
          const idx = Number(e.target.dataset.index);
          const val = e.target.value.trim();
          if (val.length === 0) {
            // prevent empty habit; revert
            e.target.value = state.habits[idx];
            return;
          }
          state.habits[idx] = val;
          // If habit count same, nothing else; save and re-render checklist if open
          saveState();
          renderChecklist();
          renderDayGrid(); // label update
          updateStats();
        });
      });

      habitList.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
          const action = btn.dataset.action;
          const idx = Number(btn.dataset.index);
          if (action === 'del') {
            if (!confirm(`Delete habit "${state.habits[idx]}"? This will remove its checks from every day.`)) return;
            state.habits.splice(idx,1);
            // update each day checks arrays
            state.days.forEach(d => {
              d.checks.splice(idx,1);
            });
            saveState();
            renderHabits();
            renderChecklist();
            renderDayGrid();
            updateStats();
          } else if (action === 'up') {
            if (idx === 0) return;
            swapHabits(idx, idx-1);
          } else if (action === 'down') {
            if (idx === state.habits.length-1) return;
            swapHabits(idx, idx+1);
          }
        });
      });
    }

    function swapHabits(a,b) {
      const tmp = state.habits[a];
      state.habits[a] = state.habits[b];
      state.habits[b] = tmp;
      // swap in each day
      state.days.forEach(d => {
        const ctmp = d.checks[a];
        d.checks[a] = d.checks[b];
        d.checks[b] = ctmp;
      });
      saveState();
      renderHabits();
      renderChecklist();
      renderDayGrid();
      updateStats();
    }

    function renderDayGrid() {
      dayGrid.innerHTML = '';
      for (let i=0;i<60;i++){
        const dayObj = state.days[i];
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        const dayNum = i+1;
        const dateText = computeDateTextForIndex(i);
        const allDone = dayObj.checks.every(Boolean);
        if (allDone) dayDiv.classList.add('done');
        // highlight today's day if start date set and matches
        const todayIndex = computeTodayIndex();
        if (todayIndex === i) dayDiv.classList.add('today');

        dayDiv.innerHTML = `<div class="dnum">Day ${dayNum}</div><div class="ddate">${dateText || ''}</div>`;
        dayDiv.dataset.index = i;
        dayDiv.addEventListener('click', () => openDay(i));
        dayGrid.appendChild(dayDiv);
      }
    }

    function computeDateTextForIndex(index) {
      if (!state.startDate) return '';
      try {
        const s = new Date(state.startDate + 'T00:00:00');
        const d = new Date(s.getTime() + index * 24*60*60*1000);
        return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
      } catch (e) {
        return '';
      }
    }

    function computeTodayIndex() {
      if (!state.startDate) return null;
      const start = new Date(state.startDate + 'T00:00:00');
      const today = todayAtMidnight();
      const diff = Math.floor((today - start) / (24*60*60*1000));
      if (diff < 0 || diff > 59) return null;
      return diff;
    }

    function openDay(index) {
      selectedIndex = index;
      dayChecklistArea.style.display = 'block';
      selectedDayText.textContent = `Day ${index+1}`;
      selectedDayHeader.textContent = `Day ${index+1} ‚Äî ${computeDateTextForIndex(index) || '(date not set)'}`;
      renderChecklist();
      // scroll into view mildly
      selectedDayHeader.scrollIntoView({behavior:'smooth', block:'center'});
      highlightSelectedDay();
    }

    function highlightSelectedDay() {
      document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
      if (selectedIndex !== null) {
        const el = dayGrid.querySelector(`.day[data-index="${selectedIndex}"]`);
        if (el) el.classList.add('selected');
      }
    }

    function renderChecklist() {
      checklist.innerHTML = '';
      if (selectedIndex === null) return;
      const day = state.days[selectedIndex];
      // ensure checks length matches habits
      if (day.checks.length !== state.habits.length) {
        day.checks = Array.from({length: state.habits.length}, (_,i) => day.checks[i] || false);
        saveState();
      }
      state.habits.forEach((h, i) => {
        const row = document.createElement('div');
        row.className = 'check-row';
        row.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px">
            <input type="checkbox" data-index="${i}" ${day.checks[i] ? 'checked' : ''} />
            <div style="font-weight:700">${escapeHtml(h)}</div>
          </div>
          <div class="muted-small">#${i+1}</div>
        `;
        checklist.appendChild(row);
      });

      // Attach change listeners
      checklist.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.addEventListener('change', e => {
          const idx = Number(e.target.dataset.index);
          state.days[selectedIndex].checks[idx] = e.target.checked;
          saveState();
          renderDayGrid();
          updateStats();
        });
      });
    }

    function markAllDone() {
      if (selectedIndex === null) return;
      state.days[selectedIndex].checks = state.days[selectedIndex].checks.map(() => true);
      saveState();
      renderChecklist();
      renderDayGrid();
      updateStats();
    }

    function clearDay() {
      if (selectedIndex === null) return;
      if (!confirm('Clear this day (uncheck all habits)?')) return;
      state.days[selectedIndex].checks = state.days[selectedIndex].checks.map(() => false);
      saveState();
      renderChecklist();
      renderDayGrid();
      updateStats();
    }

    function addHabitHandler() {
      const val = newHabit.value.trim();
      if (!val) return;
      state.habits.push(val);
      // add default false check for all days
      state.days.forEach(d => d.checks.push(false));
      newHabit.value = '';
      saveState();
      renderHabits();
      renderChecklist();
      renderDayGrid();
      updateStats();
    }

    function resetHabitsToDefault() {
      if (!confirm('Reset habits to defaults? This will replace your current habits (checks for removed habits will be lost).')) return;
      state.habits = [...defaultHabits];
      state.days.forEach(d => d.checks = Array(state.habits.length).fill(false));
      saveState();
      renderHabits();
      renderChecklist();
      renderDayGrid();
      updateStats();
    }

    function prevDay() {
      if (selectedIndex === null) {
        selectedIndex = 0;
      } else {
        selectedIndex = Math.max(0, selectedIndex - 1);
      }
      openDay(selectedIndex);
    }

    function nextDay() {
      if (selectedIndex === null) {
        selectedIndex = 0;
      } else {
        selectedIndex = Math.min(59, selectedIndex + 1);
      }
      openDay(selectedIndex);
    }

    function openToday() {
      const idx = computeTodayIndex();
      if (idx === null) {
        alert('Today is outside your 60-day window or start date is not set.');
        return;
      }
      openDay(idx);
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `habit60_backup_${formatDateYMD(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importDataFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!Array.isArray(parsed.habits) || !Array.isArray(parsed.days)) {
            alert('Invalid file format.');
            return;
          }
          // basic acceptance with confirm
          if (!confirm('Importing will replace current data. Proceed?')) return;
          // normalize: ensure 60 days
          if (parsed.days.length !== 60) {
            // try to coerce or create days
            const newDays = Array.from({length:60}, (_,i) => {
              const src = parsed.days[i] || { checks: Array(parsed.habits.length).fill(false) };
              return { checks: Array.from(src.checks || []).slice(0, parsed.habits.length).concat(Array(Math.max(0, parsed.habits.length - (src.checks || []).length)).fill(false)) };
            });
            parsed.days = newDays;
          } else {
            // ensure each day's checks length matches habits
            parsed.days = parsed.days.map(d => {
              if (!Array.isArray(d.checks)) d.checks = Array(parsed.habits.length).fill(false);
              else if (d.checks.length < parsed.habits.length) d.checks = d.checks.concat(Array(parsed.habits.length - d.checks.length).fill(false));
              else if (d.checks.length > parsed.habits.length) d.checks = d.checks.slice(0, parsed.habits.length);
              return { checks: d.checks };
            });
          }
          state = {
            startDate: parsed.startDate || null,
            habits: parsed.habits,
            days: parsed.days
          };
          saveState();
          applyStateToUI();
          alert('Import successful.');
        } catch (e) {
          console.error(e);
          alert('Failed to import file.');
        }
      };
      reader.readAsText(file);
    }

    function clearAll() {
      if (!confirm('Clear all data (this will reset start date, habits and all checks)?')) return;
      state = defaultState();
      saveState();
      applyStateToUI();
    }

    function applyStateToUI() {
      // set start date input
      startInput.value = state.startDate || '';
      startDateLabel.textContent = state.startDate || '(not set)';
      renderHabits();
      renderDayGrid();
      dayChecklistArea.style.display = 'none';
      selectedIndex = null;
      selectedDayText.textContent = 'None';
      updateStats();
    }

    function updateStats() {
      // Days completed = count of days where all habits done
      const daysCompleted = state.days.filter(d => d.checks.every(Boolean)).length;
      daysTrackedLabel.textContent = daysCompleted;
      // Overall progress percent = (total checks done) / (60 * habitCount) *100
      const totalSlots = 60 * Math.max(1, state.habits.length);
      let totalDone = 0;
      state.days.forEach(d => d.checks.forEach(c => { if (c) totalDone++; }));
      const pct = totalSlots === 0 ? 0 : Math.round((totalDone / totalSlots) * 100);
      percentLabel.textContent = `${pct}%`;
      progFill.style.width = `${pct}%`;
      saveState();
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Events
    startInput.addEventListener('change', e => {
      const val = e.target.value || null;
      if (val) {
        // validate date
        try {
          const d = new Date(val + 'T00:00:00');
          if (isNaN(d.getTime())) throw new Error('Invalid date');
          state.startDate = val;
          startDateLabel.textContent = state.startDate;
          renderDayGrid();
          updateStats();
          saveState();
        } catch {
          alert('Invalid date chosen.');
          state.startDate = null;
          startDateLabel.textContent = '(not set)';
          saveState();
        }
      } else {
        state.startDate = null;
        startDateLabel.textContent = '(not set)';
        renderDayGrid();
        saveState();
      }
    });

    addHabit.addEventListener('click', addHabitHandler);
    newHabit.addEventListener('keydown', e => {
      if (e.key === 'Enter') addHabitHandler();
    });

    resetHabitsBtn.addEventListener('click', resetHabitsToDefault);
    prevDayBtn.addEventListener('click', prevDay);
    nextDayBtn.addEventListener('click', nextDay);
    markAllBtn.addEventListener('click', markAllDone);
    clearDayBtn.addEventListener('click', clearDay);
    markTodayBtn.addEventListener('click', openToday);
    exportBtn.addEventListener('click', exportData);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importDataFromFile(file);
      e.target.value = '';
    });
    clearAllBtn.addEventListener('click', clearAll);

    // Init
    applyStateToUI();

    // Small UX: show tooltip/date for today's index when start changes
    function attachStartHint() {
      // no-op for now; could show ephemeral messages
    }

    // When the page loads, if start date exists, highlight today and open today's checklist automatically?
    // We choose not to open automatically to avoid surprising the user. But we highlight today's day visually.
    // However if today's index is within range, show a subtle hint in console:
    const todayIdx = computeTodayIndex();
    if (todayIdx !== null) {
      console.log('Today falls on day index', todayIdx+1);
    }

    // Final safety: ensure state consistency
    saveState();

    // End script
  </script>
</body>
</html>
